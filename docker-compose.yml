services:
  fluxsolutions-postgres:
    image: postgres:16-alpine
    container_name: fluxsolutions-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - fluxsolutions-postgres-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - fluxsolutions-internal
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 10s
      timeout: 5s
      retries: 10

  fluxsolutions-minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: fluxsolutions-minio
    restart: unless-stopped
    command: server /data --console-address ':9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - fluxsolutions-minio-data:/data
    ports:
      - '9000:9000'
      - '9001:9001'
    networks:
      - fluxsolutions-internal
    healthcheck:
      test:
        [
          'CMD-SHELL',
          '(command -v curl >/dev/null 2>&1 && curl -fsS http://127.0.0.1:9000/minio/health/live >/dev/null) || (command -v wget >/dev/null 2>&1 && wget -q -O /dev/null http://127.0.0.1:9000/minio/health/live)',
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  fluxsolutions-minio-init:
    image: minio/mc:RELEASE.2025-01-17T23-25-50Z
    container_name: fluxsolutions-minio-init
    depends_on:
      fluxsolutions-minio:
        condition: service_started
    entrypoint:
      - /bin/sh
      - -c
      - |
        until mc alias set fluxsolutions http://fluxsolutions-minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do
          echo "Waiting for MinIO..."
          sleep 2
        done
        mc mb -p fluxsolutions/${S3_BUCKET} || true
        mc anonymous set none fluxsolutions/${S3_BUCKET}
    networks:
      - fluxsolutions-internal
    restart: 'no'

  fluxsolutions-api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: fluxsolutions-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 4000
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@fluxsolutions-postgres:5432/${POSTGRES_DB}?schema=public
      S3_ENDPOINT: http://fluxsolutions-minio:9000
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      COOKIE_SECURE: 'true'
      ENABLE_CLAMAV: ${ENABLE_CLAMAV}
      CLAMAV_HOST: fluxsolutions-clamav
      CLAMAV_PORT: 3310
    depends_on:
      fluxsolutions-postgres:
        condition: service_healthy
      fluxsolutions-minio:
        condition: service_started
      fluxsolutions-minio-init:
        condition: service_completed_successfully
    command: >
      sh -c "npm run prisma:migrate:deploy --workspace @fluxsolutions/api &&
      node apps/api/dist/index.js"
    expose:
      - '4000'
    networks:
      - fluxsolutions-internal
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:4000/healthz']
      interval: 15s
      timeout: 5s
      retries: 10

  fluxsolutions-web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: fluxsolutions-web
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      NEXT_PUBLIC_MAX_FILE_SIZE_BYTES: ${MAX_FILE_SIZE_BYTES}
    depends_on:
      fluxsolutions-api:
        condition: service_healthy
    expose:
      - '3000'
    networks:
      - fluxsolutions-internal
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:3000']
      interval: 15s
      timeout: 5s
      retries: 10

  fluxsolutions-nginx:
    image: nginx:1.27-alpine
    container_name: fluxsolutions-nginx
    restart: unless-stopped
    depends_on:
      fluxsolutions-web:
        condition: service_healthy
      fluxsolutions-api:
        condition: service_healthy
      fluxsolutions-minio:
        condition: service_started
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./deploy/certbot/www:/var/www/certbot
      - ./deploy/certbot/conf:/etc/letsencrypt
    networks:
      - fluxsolutions-internal
      - fluxsolutions-edge
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost/nginx-health']
      interval: 15s
      timeout: 5s
      retries: 10

  fluxsolutions-clamav:
    image: clamav/clamav:1.4
    container_name: fluxsolutions-clamav
    restart: unless-stopped
    profiles: ['security']
    networks:
      - fluxsolutions-internal
    healthcheck:
      test: ['CMD-SHELL', 'pidof clamd >/dev/null']
      interval: 30s
      timeout: 10s
      retries: 10

  fluxsolutions-certbot:
    image: certbot/certbot:v3.1.0
    container_name: fluxsolutions-certbot
    profiles: ['tls']
    volumes:
      - ./deploy/certbot/www:/var/www/certbot
      - ./deploy/certbot/conf:/etc/letsencrypt
    entrypoint:
      - /bin/sh
      - -c
      - |
        trap exit TERM
        while :; do
          certbot renew --webroot -w /var/www/certbot --quiet || true
          sleep 12h & wait $${!}
        done
    networks:
      - fluxsolutions-edge

volumes:
  fluxsolutions-postgres-data:
  fluxsolutions-minio-data:

networks:
  fluxsolutions-internal:
    driver: bridge
  fluxsolutions-edge:
    driver: bridge
